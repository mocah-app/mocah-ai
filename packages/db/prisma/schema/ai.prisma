// ai.prisma
// AI & Generation - Tracking AI operations and content

model GenerationHistory {
  id          String   @id @default(uuid())
  organizationId String
  userId      String
  type        GenerationType
  prompt      String   @db.Text
  result      String?  @db.Text
  model       AIModel?
  tokensUsed  Int?
  cost        Decimal? @db.Decimal(10, 4)
  status      GenerationStatus @default(completed)
  error       String?  @db.Text
  metadata    Json?
  createdAt   DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  images       GeneratedImage[]

  @@index([organizationId])
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([createdAt])
  @@map("generation_history")
}

model GeneratedImage {
  id                String   @id @default(uuid())
  generationHistoryId String
  parentImageId     String?  // Self-referential: links to original image for variations
  url               String
  prompt            String   @db.Text
  model             AIModel?
  size              String?  // 1024x1024, etc.
  cost              Decimal? @db.Decimal(10, 4)
  version           Int      @default(1) // Version number (1 for original, increments for variations)
  variationType     ImageVariationType @default(original)
  isActive          Boolean  @default(true) // Current/active version
  changeNote        String?  @db.Text // Optional note about this version
  createdAt         DateTime @default(now())

  // Relations
  generationHistory GenerationHistory @relation(fields: [generationHistoryId], references: [id], onDelete: Cascade)
  parentImage       GeneratedImage?   @relation("ImageVersions", fields: [parentImageId], references: [id], onDelete: SetNull)
  childImages       GeneratedImage[]  @relation("ImageVersions")

  @@index([generationHistoryId])
  @@index([parentImageId])
  @@index([createdAt])
  @@index([isActive])
  @@index([variationType])
  @@map("generated_image")
}

model AIPrompt {
  id          String   @id @default(uuid())
  organizationId String
  userId      String
  prompt      String   @db.Text
  context     Json?    // Additional context data
  createdAt   DateTime @default(now())

  // Relations
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([createdAt])
  @@map("ai_prompt")
}

model UsageQuota {
  id              String     @id @default(uuid())
  userId          String     // Account-level tracking (not organization)
  plan            PlanName   // Plan at time of period creation
  
  // Billing period
  periodStart     DateTime
  periodEnd       DateTime
  
  // Template generation usage
  templatesUsed   Int        @default(0)
  templatesLimit  Int        // Based on plan: 75, 200, or 500
  
  // Image generation usage
  imagesUsed      Int        @default(0)
  imagesLimit     Int        // Based on plan: 20, 100, or 300
  
  // Sync tracking
  lastSyncedAt    DateTime   @default(now())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  // Relations
  user            User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, periodStart])
  @@index([userId])
  @@index([userId, periodStart, periodEnd])
  @@index([periodStart, periodEnd])
  @@map("usage_quota")
}

