// templates.prisma
// Template Management - React Email based content creation and storage

model Template {
  id             String   @id @default(uuid())
  organizationId String
  name           String
  description    String?
  subject        String?  // Email subject line
  category       String?
  isPublic       Boolean  @default(false)
  isFavorite     Boolean  @default(false)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  deletedAt      DateTime?
  
  // React Email Architecture
  reactEmailCode   String?   @db.Text  // Complete React Email component (source of truth)
  styleType        StyleType @default(STYLE_OBJECTS)
  styleDefinitions Json?               // Style objects as JSON
  htmlCode         String?   @db.Text  // Rendered HTML (cache)
  tableHtmlCode    String?   @db.Text  // Email-safe table HTML (cache)
  previewText      String?             // Email preview text
  
  // Version Management
  currentVersionId String?

  // Relations
  organization      Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  currentVersion    TemplateVersion? @relation("CurrentVersion", fields: [currentVersionId], references: [id], onDelete: SetNull)
  versions          TemplateVersion[]
  exports           Export[]
  categoryRelations TemplateCategoryRelation[]
  messages          ChatMessage[]

  @@index([organizationId])
  @@index([category])
  @@index([isPublic])
  @@index([deletedAt])
  @@map("template")
}

model TemplateVersion {
  id          String   @id @default(uuid())
  templateId  String
  version     Int      @default(1)
  name        String?  // Optional custom name (e.g., "Black Friday V2")
  subject     String?
  changeNote  String?
  isCurrent   Boolean  @default(false)
  createdAt   DateTime @default(now())
  createdBy   String?  // userId who created this version
  
  // Version Chain 
  parentVersionId String?
  
  // AI Generation Metadata 
  metadata    Json?    // { generatedFrom: string, aiModel: string, prompt: string, etc. }
  
  // React Email Architecture 
  reactEmailCode   String?   @db.Text  // Complete React Email component (source of truth)
  styleType        StyleType @default(STYLE_OBJECTS)
  styleDefinitions Json?               // Style objects as JSON
  htmlCode         String?   @db.Text  // Rendered HTML (cache)
  tableHtmlCode    String?   @db.Text  // Email-safe table HTML (cache)
  previewText      String?             // Email preview text

  // Relations
  template         Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  currentVersionOf Template[] @relation("CurrentVersion")
  parentVersion    TemplateVersion? @relation("VersionChain", fields: [parentVersionId], references: [id], onDelete: SetNull)
  childVersions    TemplateVersion[] @relation("VersionChain")

  @@unique([templateId, version])
  @@index([templateId])
  @@index([createdAt])
  @@index([isCurrent])
  @@index([parentVersionId])
  @@map("template_version")
}

model TemplateCategory {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  deletedAt   DateTime?

  // Relations
  templates   TemplateCategoryRelation[]

  @@index([slug])
  @@index([deletedAt])
  @@map("template_category")
}

model TemplateCategoryRelation {
  id          String   @id @default(uuid())
  templateId  String
  categoryId String
  createdAt   DateTime @default(now())

  // Relations
  template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)
  category    TemplateCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([templateId, categoryId])
  @@index([templateId])
  @@index([categoryId])
  @@map("template_category_relation")
}

model TemplateLibrary {
  id               String    @id @default(uuid())
  name             String
  description      String?
  subject          String?
  category         String?
  thumbnail        String?
  isPremium        Boolean   @default(false)
  tags             String[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  deletedAt        DateTime?
  
  // React Email Architecture
  reactEmailCode   String?   @db.Text
  styleType        StyleType @default(STYLE_OBJECTS)
  styleDefinitions Json?
  previewText      String?

  // Relations
  customizations WorkspaceTemplateLibrary[]

  @@index([category])
  @@index([isPremium])
  @@index([deletedAt])
  @@map("template_library")
}

model WorkspaceTemplateLibrary {
  id                String   @id @default(uuid())
  organizationId    String
  templateLibraryId String
  isCustomized      Boolean  @default(false)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  // Custom React Email code (if customized)
  customReactEmailCode String? @db.Text
  customStyleDefinitions Json?

  // Relations
  organization     Organization    @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  templateLibrary  TemplateLibrary @relation(fields: [templateLibraryId], references: [id], onDelete: Cascade)

  @@unique([organizationId, templateLibraryId])
  @@index([organizationId])
  @@index([templateLibraryId])
  @@map("workspace_template_library")
}

model Export {
  id          String   @id @default(uuid())
  templateId  String
  format      ExportFormat
  fileUrl     String?
  fileSize    Int?
  metadata    Json?    // Additional export metadata
  createdAt   DateTime @default(now())

  // Relations
  template    Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([format])
  @@index([createdAt])
  @@map("export")
}

model ChatMessage {
  id          String   @id @default(uuid())
  templateId String
  role       ChatMessageRole
  content    String   @db.Text
  isStreaming Boolean  @default(false)
  metadata   Json?    // Store generation result: { subject, previewText, reactEmailCode }
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relations
  template   Template @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@index([templateId])
  @@index([createdAt])
  @@map("chat_message")
}

